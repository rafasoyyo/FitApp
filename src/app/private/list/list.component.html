<div class="mx-2 my-4">
  <p class="text-2xl font-bold my-3">
    {{ isAdmin() ? 'Gestión de Clases' : 'Tus próximas clases' }}</p>

  @if (isAdmin()) {
  <div class="mb-4">
    <label class="block text-sm font-medium mb-2 text-500">Filtrar por Alumno</label>
    <p-select [options]="alumnos()" [ngModel]="selectedStudent()" (ngModelChange)="selectedStudent.set($event); updateGroupedLessons()"
      optionLabel="name" placeholder="Selecciona un alumno" class="w-full" [filter]="true" filterBy="name"
      appendTo="body">
      <ng-template pTemplate="selectedItem" let-selectedOption>
        @if (selectedOption) {
        <div class="flex align-items-center gap-2">
          <div class="w-1rem h-1rem border-circle flex align-items-center justify-content-center font-bold text-[10px] flex-shrink-0"
            [style]="{ backgroundColor: selectedOption.bgColor, color: selectedOption.color }">
            {{ selectedOption.capitalLetter }}
          </div>
          <span class="text-sm">{{ selectedOption.name }}</span>
        </div>
        }
      </ng-template>
      <ng-template let-user pTemplate="item">
        <div class="flex align-items-center gap-2">
          <div class="w-1rem h-1rem border-circle flex align-items-center justify-content-center font-bold text-[10px] flex-shrink-0"
            [style]="{ backgroundColor: user.bgColor, color: user.color }">
            {{ user.capitalLetter }}
          </div>
          <span class="text-sm">{{ user.name }}</span>
        </div>
      </ng-template>
    </p-select>
  </div>
  }
</div>


<div class="flex flex-column gap-5 mx-2 pb-5">
  @for (group of groupedLessons(); track group.weekLabel) {
  <div class="flex flex-column gap-2">
    <div class="flex align-items-center gap-2 sticky top-0 surface-section pt-3 z-2">
      <div class="h-2rem w-4px bg-primary border-round"></div>
      <h3 class="text-sm font-bold text-700 uppercase tracking-wider m-0">{{ group.weekLabel }}</h3>
    </div>

    <div class="flex flex-column gap-3">
      @for (item of group.lessons; track (item.date + item.agendaId)) {
      <div class="p-3 border-round-xl border-1 surface-border surface-card shadow-1 transition-all transition-duration-200 hover:surface-100">
        <div class="flex align-items-center gap-3 mb-3">
          <p-avatar icon="pi pi-calendar" shape="circle" class="flex-shrink-0"
            [pt]="{ root: { class: 'bg-primary-100 text-primary' } }" />
          <div class="flex flex-column">
            <span class="text-lg font-bold capitalize">{{ item.displayDate }}</span>
            <span class="text-xs text-500">{{ item.startHour }} - {{ item.endHour }}</span>
          </div>
          <p-badge [value]="item.members.size.toString()" class="ml-auto" severity="info" />
        </div>

        @if (item.note) {
        <div class="mb-3">
          <p-tag icon="pi pi-exclamation-triangle" severity="warn" [value]="item.note" [rounded]="true" />
        </div>
        }

        <div class="flex flex-wrap gap-2">
          @for (user of getMemberData(item.members); track user.id) {
          <div class="flex align-items-center gap-2 px-2 py-1 border-round-lg surface-100 border-1 surface-border">
            <div
              class="w-1rem h-1rem border-circle flex align-items-center justify-content-center font-bold text-[8px]"
              [style]="{ backgroundColor: user.bgColor, color: user.color }">
              {{ user.capitalLetter }}
            </div>
            <span class="text-xs font-semibold">{{ user.name }} {{ user.id === loggedUser()?.id ? '(Tú)' : '' }}</span>
          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>
  } @empty {
  <div class="flex flex-column align-items-center gap-3 p-8">
    <i class="pi pi-calendar-times text-5xl text-300"></i>
    <span class="text-xl text-center text-600 font-medium">
      {{ (isAdmin() && !selectedStudent()) ? 'Selecciona un alumno para ver sus clases.' : 'No hay clases activas próximas.' }}
    </span>
    @if(!isAdmin()) {
      <p-button label="Ver Calendario" [routerLink]="['/calendar']" severity="help" size="small" [rounded]="true" />
    }
  </div>
  }
</div>
